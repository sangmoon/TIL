<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="자바 잘 짜보자">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Effective Java">
<meta property="og:description" content="자바 잘 짜보자">
<meta property="og:type" content="article">
<meta property="og:url" content="https://sangmoon.github.io/TIL/effectivejava/classesandinterfaces/item17/"><meta property="article:section" content="EffectiveJava">
<meta property="article:published_time" content="2021-10-23T00:00:00+00:00">
<meta property="article:modified_time" content="2021-10-23T00:00:00+00:00">
<title>Effective Java | Sangmoon's TIL</title>
<link rel=manifest href=/TIL/manifest.json>
<link rel=icon href=/TIL/favicon.png type=image/x-icon>
<link rel=stylesheet href=/TIL/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous>
<script defer src=/TIL/flexsearch.min.js></script>
<script defer src=/TIL/en.search.min.58e317a58bdb983ff9fe64dbce44994883782a83ea5a5d5fbf080e12279c4e0f.js integrity="sha256-WOMXpYvbmD/5/mTbzkSZSIN4KoPqWl1fvwgOEiecTg8=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/TIL/><span>Sangmoon's TIL</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/TIL/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Effective Java</strong>
<label for=toc-control>
<img src=/TIL/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#item-17-minimize-mutability>Item 17: Minimize mutability</a>
<ul>
<li><a href=#immutable-class-만들기-위한-규칙>immutable class 만들기 위한 규칙</a></li>
<li><a href=#immutable-object-장점>Immutable Object 장점</a></li>
<li><a href=#immutable-object-단점>Immutable Object 단점</a></li>
<li><a href=#요약>요약</a></li>
<li><a href=#oma-예제>OMA 예제</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class=markdown><h2 id=item-17-minimize-mutability>
Item 17: Minimize mutability
<a class=anchor href=#item-17-minimize-mutability>#</a>
</h2>
<p><code>immutable class</code> 는 변경될 수 없는 인스턴스들의 클래스 이다. String, boxed primitive type, BigInteger 나 BigDecimal 등이 immutable class의 예이다.
mutable class 보다 설계하기 쉽고 에러도 적고 더 안전하다.</p>
<h3 id=immutable-class-만들기-위한-규칙>
immutable class 만들기 위한 규칙
<a class=anchor href=#immutable-class-%eb%a7%8c%eb%93%a4%ea%b8%b0-%ec%9c%84%ed%95%9c-%ea%b7%9c%ec%b9%99>#</a>
</h3>
<ol>
<li>객체의 상태를 바꾸는 메소드(Mutator)를 제공하지마라</li>
<li>클래스를 상속할 수 없게 만들어라</li>
<li>모든 필드를 final로 선언해라</li>
<li>모든 필드를 private로 만들어라.</li>
<li>mutable object에 대한 접근 제한을 확실히 해라. 클래스가 mutable object 가지고 있으면 client는 절대 접근할 수 없게 해야 한다. client 가 제공하는 객체로 초기화하지말고, field 를 반환해서도 안된다. 생성자나 accesor, readObject(Item 88)에서 defensive copy(Item 50)를 사용하자.</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// Immutable complex number class
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Complex</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>double</span> re<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>double</span> im<span style=color:#f92672>;</span>

    pubic <span style=color:#a6e22e>Complex</span><span style=color:#f92672>(</span><span style=color:#66d9ef>double</span> re<span style=color:#f92672>,</span> <span style=color:#66d9ef>double</span> im<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> re<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>im</span> <span style=color:#f92672>=</span> im<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>double</span> <span style=color:#a6e22e>realPart</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span><span style=color:#66d9ef>return</span> re<span style=color:#f92672>;}</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>double</span> <span style=color:#a6e22e>imaginaryPart</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span><span style=color:#66d9ef>return</span> im<span style=color:#f92672>;}</span>

    <span style=color:#66d9ef>public</span> Complex <span style=color:#a6e22e>plus</span><span style=color:#f92672>(</span>Complex c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>(</span>re <span style=color:#f92672>+</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span><span style=color:#f92672>,</span> im <span style=color:#f92672>+</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> Complex <span style=color:#a6e22e>minus</span><span style=color:#f92672>(</span>Complex c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>(</span>re <span style=color:#f92672>-</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span><span style=color:#f92672>,</span> im <span style=color:#f92672>-</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> Complex <span style=color:#a6e22e>times</span><span style=color:#f92672>(</span>Complex c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>(</span>re <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span> <span style=color:#f92672>-</span> im <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span><span style=color:#f92672>,</span>
                            re <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span> <span style=color:#f92672>+</span> im <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> Complex <span style=color:#a6e22e>dividedBy</span><span style=color:#f92672>(</span>Complex c<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>double</span> tmp <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span> <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span> <span style=color:#f92672>+</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span> <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>((</span>re <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span> <span style=color:#f92672>+</span> im <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span><span style=color:#f92672>)</span> <span style=color:#f92672>/</span> tmp
                            <span style=color:#f92672>(</span>im <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span> <span style=color:#f92672>-</span> re <span style=color:#f92672>*</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span><span style=color:#f92672>)</span> <span style=color:#f92672>/</span> tmp<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>Object o<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>o <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>)</span>
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(!(</span>o <span style=color:#66d9ef>instanceof</span> Complex<span style=color:#f92672>))</span>
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
        Complex c <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Complex<span style=color:#f92672>)</span> o<span style=color:#f92672>;</span>

        <span style=color:#66d9ef>return</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>compare</span><span style=color:#f92672>(</span>c<span style=color:#f92672>.</span><span style=color:#a6e22e>re</span><span style=color:#f92672>,</span> re<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0
            <span style=color:#f92672>&amp;&amp;</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>compare</span><span style=color:#f92672>(</span>c<span style=color:#f92672>.</span><span style=color:#a6e22e>im</span><span style=color:#f92672>,</span> im<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> 0
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>hashCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> 31 <span style=color:#f92672>*</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>(</span>re<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>hashCode</span><span style=color:#f92672>(</span>im<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;(&#34;</span> <span style=color:#f92672>+</span> re <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; + &#34;</span> <span style=color:#f92672>+</span> im <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;i)&#34;</span> <span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=immutable-object-장점>
Immutable Object 장점
<a class=anchor href=#immutable-object-%ec%9e%a5%ec%a0%90>#</a>
</h3>
<p><strong>Immutable Object는 기본적으로 thread-safe 하다</strong>. 멀티 쓰레드가 동시에 접근해 state를 오염시킬 수 없다. 이게 thread 안전성을 확보하는 가장 쉬운 방법이다.</p>
<p><strong>Immutable Objects는 자유롭게 공유할 수 있다</strong>. 따라서 클라이언트가 가능한한 갖고 있는 객체를 재사용하도록 해야 한다. 가장 쉬운 방법은 public static final constants 를 제공하는 것이다. 예를 들어 Complex class는 다음 과 과 같은 상수를 제공할 수 있다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Complex ZERO <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Complex ONE  <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Complex I    <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 1<span style=color:#f92672>);</span>
</code></pre></div><p>여기서 한 걸음 더 나아가면 <strong>immutable class는 static factory 를 사용해 자주 사용하는 instance를 캐시함으로써 존재하는 객체를 새로 만드는 것을 피할 수 있다</strong>. 모든 boxed primitive class와 BigInteger는 이 방식을 사용한다. 이 방식을 통해 client 메모리 사용량과 GC 부하를 줄일 수 있다. public 생성자 대신에 static factory method를 사용하는 방식은 cache를 나중에 추가할 수 있는 유연성을 준다.</p>
<p>자유롭게 공유가능한 immutable Object의 특징은 결과적으로 <strong><em>depensive copy</em></strong>(Item 50) 을 하지 않아도 되게 만든다. 따라서 clone method 나 copy 생성자를 만들 필요가 없다.</p>
<p><strong>immuatble 객체 자체를 공유할 수 있을 뿐 아니라 내부 객체도 공유 할 수 있다</strong>.
예를 들어 BigInteger의 경우 부호를 나타내는 <code>int</code> 와 크기를 나타내는 <code>int[]</code> 로 구성되는데 <code>negate</code> method는 크기는 같고 부호만 다른 BigInteger를 반환한다. 이 때 array를 copy 할 필요 없다. 새로운 BigInteger 객체는 original과 같은 array를 갖고 있어도 된다.</p>
<h3 id=immutable-object-단점>
Immutable Object 단점
<a class=anchor href=#immutable-object-%eb%8b%a8%ec%a0%90>#</a>
</h3>
<p><strong>immutable objects의 가장 큰 문제는 값이 다르면 별도의 객체를 생성해야 한다는 점이다</strong>. 객체 생성이 충분히 비쌀 수 있기에 이는 성능 저하로 이어질 수 있다. 거기에 생성 과정에서 여러 step을 밟는 다면 치명적인 속도 저하로 이어질 수 있다.</p>
<p>immutability를 만족하기 위해서 subclass가 없도록 강제했었다. 하지만 좀 더 유연한 다른 방식이 있다. 바로 생성자를 모두 private 나 package-private로 만들고 <code>public static factory</code>를 사용하는 것이다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Complex</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>double</span> re<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>double</span> im<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Complex</span><span style=color:#f92672>(</span><span style=color:#66d9ef>double</span> re<span style=color:#f92672>,</span> <span style=color:#66d9ef>double</span> im<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>re</span> <span style=color:#f92672>=</span> re<span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>im</span> <span style=color:#f92672>=</span> im<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Complex <span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span><span style=color:#66d9ef>double</span> re<span style=color:#f92672>,</span> <span style=color:#66d9ef>double</span> im<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Complex<span style=color:#f92672>(</span>re<span style=color:#f92672>,</span> im<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>이렇게 하면 client에겐 immutable class는 효과적인 final이다(같은 패키지가 아니므로).
여러 구현체를 쓸 수 있는 유연함과 더불어 이 방식으로 추후 성능 튜닝(cache 등을 통해)이 무리 없이 제공될 수 있다.</p>
<h3 id=요약>
요약
<a class=anchor href=#%ec%9a%94%ec%95%bd>#</a>
</h3>
<p>요약 하면 setter를 모두 만드려고 하지 마라. 클래스는 가능한 한 immutable 해야 한다.
만약 immutable 하게 할 수 없다면 최대한 변경할 수 없도록 제한해라. 생성자는 모든 불변 변수를 초기화 할 수 있게 잘 설계해야 한다.</p>
<h3 id=oma-예제>
OMA 예제
<a class=anchor href=#oma-%ec%98%88%ec%a0%9c>#</a>
</h3>
<p><code>OrderModificationResultMessage</code></p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#item-17-minimize-mutability>Item 17: Minimize mutability</a>
<ul>
<li><a href=#immutable-class-만들기-위한-규칙>immutable class 만들기 위한 규칙</a></li>
<li><a href=#immutable-object-장점>Immutable Object 장점</a></li>
<li><a href=#immutable-object-단점>Immutable Object 단점</a></li>
<li><a href=#요약>요약</a></li>
<li><a href=#oma-예제>OMA 예제</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>