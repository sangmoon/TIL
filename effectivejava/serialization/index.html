<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="자바 잘 짜보자">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Effective Java">
<meta property="og:description" content="자바 잘 짜보자">
<meta property="og:type" content="article">
<meta property="og:url" content="https://sangmoon.github.io/TIL/effectivejava/serialization/"><meta property="article:section" content="EffectiveJava">
<meta property="article:published_time" content="2021-10-23T00:00:00+00:00">
<meta property="article:modified_time" content="2021-10-23T00:00:00+00:00">
<title>Effective Java | Sangmoon's TIL</title>
<link rel=manifest href=/TIL/manifest.json>
<link rel=icon href=/TIL/favicon.png type=image/x-icon>
<link rel=stylesheet href=/TIL/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous>
<script defer src=/TIL/flexsearch.min.js></script>
<script defer src=/TIL/en.search.min.58e317a58bdb983ff9fe64dbce44994883782a83ea5a5d5fbf080e12279c4e0f.js integrity="sha256-WOMXpYvbmD/5/mTbzkSZSIN4KoPqWl1fvwgOEiecTg8=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/TIL/><span>Sangmoon's TIL</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/TIL/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Effective Java</strong>
<label for=toc-control>
<img src=/TIL/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#규칙-76-readobject-메서드는-방어적으로-구현하라>규칙 76 readObject 메서드는 방어적으로 구현하라</a>
<ul>
<li><a href=#immutable-class>immutable class</a></li>
<li><a href=#방어-규칙>방어 규칙</a></li>
<li><a href=#공격1-악의적인-바이트-스트림-공격>공격1. 악의적인 바이트 스트림 공격</a></li>
<li><a href=#해결책1-readobject에서-유효성-검사-구현>해결책1. readObject에서 유효성 검사 구현</a></li>
<li><a href=#공격2-악의적-객체-참조>공격2. 악의적 객체 참조</a></li>
<li><a href=#해결책2-방어적-복사>해결책2 방어적 복사</a></li>
<li><a href=#요약>요약</a></li>
</ul>
</li>
<li><a href=#규칙77-개체-통제가-필요하다면-readresolve-대신-enum-자료형을-사용해라>규칙77 개체 통제가 필요하다면 readResolve 대신 enum 자료형을 사용해라</a>
<ul>
<li><a href=#readresove-통한-싱글톤>readResove 통한 싱글톤</a></li>
<li><a href=#비-transient-필드-통한-참조-가로채기>비-transient 필드 통한 참조 가로채기</a></li>
<li><a href=#해결책>해결책</a></li>
<li><a href=#readresove와-접근-권한>readResove와 접근 권한</a></li>
<li><a href=#요약-1>요약</a></li>
</ul>
</li>
<li><a href=#규칙78-직렬화된-객체-대신-직렬화-프락시를-고려해-보라>규칙78 직렬화된 객체 대신 직렬화 프락시를 고려해 보라</a>
<ul>
<li><a href=#직렬화-프록시-단점>직렬화 프록시 단점</a></li>
<li><a href=#요약-2>요약</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class=markdown><h1 id=serialization>
Serialization
<a class=anchor href=#serialization>#</a>
</h1>
<h2 id=규칙-76-readobject-메서드는-방어적으로-구현하라>
규칙 76 readObject 메서드는 방어적으로 구현하라
<a class=anchor href=#%ea%b7%9c%ec%b9%99-76-readobject-%eb%a9%94%ec%84%9c%eb%93%9c%eb%8a%94-%eb%b0%a9%ec%96%b4%ec%a0%81%ec%9c%bc%eb%a1%9c-%ea%b5%ac%ed%98%84%ed%95%98%eb%9d%bc>#</a>
</h2>
<p>변경 불가능 클래스 조차, 직렬화를 통해 불변식이 깨질 수 있다.</p>
<ol>
<li><code>불변식 깨짐</code> -> readObject 유효성 검사</li>
<li><code>악의적 객체 참조</code> -> readObject 에서 방어적 복사</li>
</ol>
<h3 id=immutable-class>
immutable class
<a class=anchor href=#immutable-class>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// 규칙 39 Period 클래스
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Period</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Date start<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Date end<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>Period</span><span style=color:#f92672>(</span>Date start<span style=color:#f92672>,</span> Date end<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>start<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>());</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>end</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>end<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>());</span>
        <span style=color:#75715e>// 방어적 규칙
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>.</span><span style=color:#a6e22e>compareTo</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>end</span><span style=color:#f92672>)</span> <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>
                    start <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; after &#34;</span> <span style=color:#f92672>+</span> end
            <span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> Date <span style=color:#a6e22e>start</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>start<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> Date <span style=color:#a6e22e>end</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>end<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> start <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; - &#34;</span> <span style=color:#f92672>+</span> end<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=방어-규칙>
방어 규칙
<a class=anchor href=#%eb%b0%a9%ec%96%b4-%ea%b7%9c%ec%b9%99>#</a>
</h3>
<ol>
<li>내부 주소는 공개하지 않는다</li>
<li>start &lt;= end 이어야 한다.</li>
</ol>
<h3 id=공격1-악의적인-바이트-스트림-공격>
공격1. 악의적인 바이트 스트림 공격
<a class=anchor href=#%ea%b3%b5%ea%b2%a91-%ec%95%85%ec%9d%98%ec%a0%81%ec%9d%b8-%eb%b0%94%ec%9d%b4%ed%8a%b8-%ec%8a%a4%ed%8a%b8%eb%a6%bc-%ea%b3%b5%ea%b2%a9>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BogusPeriod</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// Byte stream could not have come from real Period instance!
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> serializedForm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#f92672>{</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xac<span style=color:#f92672>,</span>
            <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xed<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x05<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x06<span style=color:#f92672>,</span> 0x50<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span>
            0x69<span style=color:#f92672>,</span> 0x6f<span style=color:#f92672>,</span> 0x64<span style=color:#f92672>,</span> 0x40<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xf8<span style=color:#f92672>,</span> 0x2b<span style=color:#f92672>,</span> 0x4f<span style=color:#f92672>,</span> 0x46<span style=color:#f92672>,</span>
            <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xc0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xf4<span style=color:#f92672>,</span> 0x02<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x02<span style=color:#f92672>,</span> 0x4c<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x03<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span>
            0x6e<span style=color:#f92672>,</span> 0x64<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x10<span style=color:#f92672>,</span> 0x4c<span style=color:#f92672>,</span> 0x6a<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x2f<span style=color:#f92672>,</span>
            0x75<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x2f<span style=color:#f92672>,</span> 0x44<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x3b<span style=color:#f92672>,</span> 0x4c<span style=color:#f92672>,</span>
            0x00<span style=color:#f92672>,</span> 0x05<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x71<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span>
            0x01<span style=color:#f92672>,</span> 0x78<span style=color:#f92672>,</span> 0x70<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x0e<span style=color:#f92672>,</span> 0x6a<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span>
            0x2e<span style=color:#f92672>,</span> 0x75<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x2e<span style=color:#f92672>,</span> 0x44<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x68<span style=color:#f92672>,</span>
            0x6a<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0x81<span style=color:#f92672>,</span> 0x01<span style=color:#f92672>,</span> 0x4b<span style=color:#f92672>,</span> 0x59<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x19<span style=color:#f92672>,</span> 0x03<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span>
            0x78<span style=color:#f92672>,</span> 0x70<span style=color:#f92672>,</span> 0x77<span style=color:#f92672>,</span> 0x08<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x66<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xdf<span style=color:#f92672>,</span> 0x6e<span style=color:#f92672>,</span>
            0x1e<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x78<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x71<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x03<span style=color:#f92672>,</span> 0x77<span style=color:#f92672>,</span> 0x08<span style=color:#f92672>,</span>
            0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xd5<span style=color:#f92672>,</span> 0x17<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x22<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x78 <span style=color:#f92672>};</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Object <span style=color:#a6e22e>deserialize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> sf<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> ObjectInputStream<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>sf<span style=color:#f92672>)).</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException <span style=color:#f92672>|</span> ClassNotFoundException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String <span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Period p <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Period<span style=color:#f92672>)</span> deserialize<span style=color:#f92672>(</span>serializedForm<span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>p<span style=color:#f92672>);</span>
        <span style=color:#75715e>// Sat Jan 02 05:00:00 KST 1999 - Mon Jan 02 05:00:00 KST 1984
</span><span style=color:#75715e></span>        <span style=color:#75715e>// 불변식 깨짐 ...!
</span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=해결책1-readobject에서-유효성-검사-구현>
해결책1. readObject에서 유효성 검사 구현
<a class=anchor href=#%ed%95%b4%ea%b2%b0%ec%b1%851-readobject%ec%97%90%ec%84%9c-%ec%9c%a0%ed%9a%a8%ec%84%b1-%ea%b2%80%ec%82%ac-%ea%b5%ac%ed%98%84>#</a>
</h3>
<p>Serializable 만 implements 하면 직렬화는 되지만 불변식 깨진다.
<code>readObject </code> 메소드 는 실질적으로 생성자나 마찬가지(byte stream을 인자로 받는 생성자)</p>
<p>유효성 검사하는 readObject 메소드를 추가한다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>readObject</span><span style=color:#f92672>(</span>ObjectInputStream s<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ClassNotFoundException <span style=color:#f92672>{</span>
    s<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultReadObject</span><span style=color:#f92672>();</span> <span style=color:#75715e>// non-static, non-transient field 채워줌
</span><span style=color:#75715e></span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>start<span style=color:#f92672>.</span><span style=color:#a6e22e>compareTo</span><span style=color:#f92672>(</span>end<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InvalidObjectException<span style=color:#f92672>(</span>start <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; after &#34;</span> <span style=color:#f92672>+</span> end<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=공격2-악의적-객체-참조>
공격2. 악의적 객체 참조
<a class=anchor href=#%ea%b3%b5%ea%b2%a92-%ec%95%85%ec%9d%98%ec%a0%81-%ea%b0%9d%ec%b2%b4-%ec%b0%b8%ec%a1%b0>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MutablePeriod</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> Period period<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> Date start<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>final</span> Date end<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>MutablePeriod</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            ByteArrayOutputStream bos <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayOutputStream<span style=color:#f92672>();</span>
            ObjectOutputStream out <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectOutputStream<span style=color:#f92672>(</span>bos<span style=color:#f92672>);</span>

            out<span style=color:#f92672>.</span><span style=color:#a6e22e>writeObject</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Period<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>()));</span>

            <span style=color:#75715e>/*
</span><span style=color:#75715e>             * 악의적 &#34;previous object refs&#34; 를 추가
</span><span style=color:#75715e>             * Period 내부 Date 필드에 대한 것
</span><span style=color:#75715e>             */</span>
            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> ref <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>0x71<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> 5<span style=color:#f92672>};</span>
            bos<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>ref<span style=color:#f92672>);</span> <span style=color:#75715e>// start field
</span><span style=color:#75715e></span>            ref<span style=color:#f92672>[</span>4<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span> <span style=color:#75715e>// {0x71, 0, 0x7e, 0, 4}
</span><span style=color:#75715e></span>            bos<span style=color:#f92672>.</span><span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>ref<span style=color:#f92672>);</span> <span style=color:#75715e>// end field
</span><span style=color:#75715e></span>
            <span style=color:#75715e>// Period 와 훔친 Date 참조 역직렬화
</span><span style=color:#75715e></span>            ObjectInputStream in <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>bos<span style=color:#f92672>.</span><span style=color:#a6e22e>toByteArray</span><span style=color:#f92672>()));</span>

            period <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Period<span style=color:#f92672>)</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>
            start <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Date<span style=color:#f92672>)</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>
            end <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Date<span style=color:#f92672>)</span> in<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>

        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IOException <span style=color:#f92672>|</span> ClassNotFoundException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> AssertionError<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        MutablePeriod mp <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MutablePeriod<span style=color:#f92672>();</span>
        Period p <span style=color:#f92672>=</span> mp<span style=color:#f92672>.</span><span style=color:#a6e22e>period</span><span style=color:#f92672>;</span>
        Date pEnd <span style=color:#f92672>=</span> mp<span style=color:#f92672>.</span><span style=color:#a6e22e>end</span><span style=color:#f92672>;</span>

        pEnd<span style=color:#f92672>.</span><span style=color:#a6e22e>setYear</span><span style=color:#f92672>(</span>78<span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>p<span style=color:#f92672>);</span>

        pEnd<span style=color:#f92672>.</span><span style=color:#a6e22e>setYear</span><span style=color:#f92672>(</span>69<span style=color:#f92672>);</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>p<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#75715e>// 결과
</span><span style=color:#75715e>// Mon Oct 08 18:04:19 KST 2018 - Sun Oct 08 18:04:19 KST 1978
</span><span style=color:#75715e>// Mon Oct 08 18:04:19 KST 2018 - Wed Oct 08 18:04:19 KST 1969
</span></code></pre></div><p>Period 역직렬화 과정에서 객체 참조가 노출됨.
방어적 복사를 readObject() 에서도 해야 한다.</p>
<h3 id=해결책2-방어적-복사>
해결책2 방어적 복사
<a class=anchor href=#%ed%95%b4%ea%b2%b0%ec%b1%852-%eb%b0%a9%ec%96%b4%ec%a0%81-%eb%b3%b5%ec%82%ac>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>readObject</span><span style=color:#f92672>(</span>ObjectInputStream s<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ClassNotFoundException <span style=color:#f92672>{</span>
    s<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultReadObject</span><span style=color:#f92672>();</span> <span style=color:#75715e>// non-static, non-transient field 채워줌
</span><span style=color:#75715e></span>
    start <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>start<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>());</span> <span style=color:#75715e>// start랑 end final 빼줘야 함
</span><span style=color:#75715e></span>    end <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date<span style=color:#f92672>(</span>end<span style=color:#f92672>.</span><span style=color:#a6e22e>getTime</span><span style=color:#f92672>());</span>

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>start<span style=color:#f92672>.</span><span style=color:#a6e22e>compareTo</span><span style=color:#f92672>(</span>end<span style=color:#f92672>)</span> <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InvalidObjectException<span style=color:#f92672>(</span>start <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; after &#34;</span> <span style=color:#f92672>+</span> end<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>java 1.4부터 위 처럼 방어적 복사 안해도 되도록 <code>writeUnshared</code>와 <code>readUnshared</code> 메소드 추가되었는데, 뒤에 나올 규칙77에 취약하므로 그냥 방어적 복사 사용할 것.
readObject 에서 override 가능한 메소드 호출하지 말 것. 보장 못함.</p>
<h3 id=요약>
요약
<a class=anchor href=#%ec%9a%94%ec%95%bd>#</a>
</h3>
<ul>
<li>readMobject 를 구현 할 때는 public 생성자 구현하듯이 해야 한다.</li>
<li>어떤 바이트스트림이 주어지더라도 유효한 객체가 생성될 수 있게 해야 한다.</li>
<li>안전한 메서드 구현은 다음 지침들을 따르자
<ul>
<li>private 로 남아야 하는 객체 참조 필드를 가진 클래스는 해당 객체를 방어적으로 복사해야 한다.</li>
<li>불변식을 검사해서 위반되면 InvalidObjectException을 던저야 한다. 불변식 검사는 방어적 복사 끝난 후에 실행되어야 한다.</li>
<li>객체 완전 역직렬화 한 다음 유효성 검사해야 한다면 ObjectInputValidation 인터페이스를 이용해라</li>
<li>직-간접적으로 override 가능 메소드 호출하지 말 것</li>
</ul>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// ObjectInputValidation 사용법
</span><span style=color:#75715e>// readObject가 다 끝나고 return 되기 직전에 validation 해줌
</span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ObjectInputValidation</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>validateObject</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> InvalidObjectException<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ObjectInputStreamDemo</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            ObjectInputStream ois <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> FileInputStream<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;test.txt&#34;</span><span style=color:#f92672>));</span>

            Example a <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Example<span style=color:#f92672>)</span> ois<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception ex<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            ex<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Example</span> <span style=color:#66d9ef>implements</span> Serializable<span style=color:#f92672>,</span> ObjectInputValidation <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>private</span> String s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Hello World!&#34;</span><span style=color:#f92672>;</span>

        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>readObject</span><span style=color:#f92672>(</span>ObjectInputStream in<span style=color:#f92672>)</span>
                <span style=color:#66d9ef>throws</span> IOException<span style=color:#f92672>,</span> ClassNotFoundException <span style=color:#f92672>{</span>
            in<span style=color:#f92672>.</span><span style=color:#a6e22e>defaultReadObject</span><span style=color:#f92672>();</span>
            in<span style=color:#f92672>.</span><span style=color:#a6e22e>registerValidation</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> 0<span style=color:#f92672>);</span> <span style=color:#75715e>// 콜백 등록
</span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>

        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>validateObject</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> InvalidObjectException <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>s</span><span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Hello World!&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Validated.&#34;</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Not validated.&#34;</span><span style=color:#f92672>);</span>
                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InvalidObjectException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Not validated.&#34;</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xac<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xed<span style=color:#f92672>,</span>                                               <span style=color:#75715e>//STREAM_MAGIC. Specifies that this is a serialization protocol.
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x05<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// STREAM_VERSION. The serialization version.
</span><span style=color:#75715e></span>0x73<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_OBJECT. Specifies that this is a new Object.
</span><span style=color:#75715e></span>0x72<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_CLASSDESC. Specifies that this is a new class.
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x06<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// Length of the class name.
</span><span style=color:#75715e></span>0x50<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x6f<span style=color:#f92672>,</span> 0x64<span style=color:#f92672>,</span>                                     <span style=color:#75715e>// the name of the class &#39;P e r i o d&#39;
</span><span style=color:#75715e></span>0x40<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xf8<span style=color:#f92672>,</span> 0x2b<span style=color:#f92672>,</span> 0x4f<span style=color:#f92672>,</span> 0x46<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xc0<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xf4<span style=color:#f92672>,</span>    <span style=color:#75715e>// SerialVersionUID, the serial version identifier of this class.
</span><span style=color:#75715e></span>0x02<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// Various flags. This particular flag says that the object supports serialization.
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x02<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// Number of fields in this class.
</span><span style=color:#75715e></span>0x4c<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// ?? field type
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x03<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// Length of the field name
</span><span style=color:#75715e></span>0x65<span style=color:#f92672>,</span> 0x6e<span style=color:#f92672>,</span> 0x64<span style=color:#f92672>,</span>                                                       <span style=color:#75715e>// e n d
</span><span style=color:#75715e></span>0x74<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_STRING. Represents a new string.
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x10<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// Length of the string.
</span><span style=color:#75715e></span>0x4c<span style=color:#f92672>,</span> 0x6a<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x2f<span style=color:#f92672>,</span> 0x75<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x2f<span style=color:#f92672>,</span> 0x44<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x3b<span style=color:#f92672>,</span> <span style=color:#75715e>// Ljava/util/Date;
</span><span style=color:#75715e></span>0x4c<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// ?? field type
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x05<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// Length of the field name
</span><span style=color:#75715e></span>0x73<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span>                                           <span style=color:#75715e>// s t a r t
</span><span style=color:#75715e></span>0x71<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_REFERENCE. Reference to an object already written into the stream.
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x01<span style=color:#f92672>,</span>                                                 <span style=color:#75715e>// 1번째 참조..?
</span><span style=color:#75715e></span>0x78<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_ENDBLOCKDATA, the end of the optional block data for an object.
</span><span style=color:#75715e></span>0x70<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>//TC_NULL, which represents the fact that there are no more superclasses because we have reached the top of the class hierarchy.
</span><span style=color:#75715e></span>0x73<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_OBJECT. Specifies that this is a new Object.
</span><span style=color:#75715e></span>0x72<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_CLASSDESC. Specifies that this is a new class.
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x0e<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// Length of the class name.
</span><span style=color:#75715e></span>0x6a<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x2e<span style=color:#f92672>,</span> 0x75<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x2e<span style=color:#f92672>,</span> 0x44<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> <span style=color:#75715e>// java.util.Date
</span><span style=color:#75715e></span>0x68<span style=color:#f92672>,</span> 0x6a<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0x81<span style=color:#f92672>,</span> 0x01<span style=color:#f92672>,</span> 0x4b<span style=color:#f92672>,</span> 0x59<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x19<span style=color:#f92672>,</span>                  <span style=color:#75715e>// serialVersionUID of the java.util.Date class
</span><span style=color:#75715e></span>0x03<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// Varius flags. SC_WRITE_METHOD. 
</span><span style=color:#75715e></span>0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span>                                                             <span style=color:#75715e>// Number of fields in this class.
</span><span style=color:#75715e></span>0x78<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>// TC_ENDBLOCKDATA, the end of the optional block data for an object.
</span><span style=color:#75715e></span>0x70<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>//TC_NULL, which represents the fact that there are no more superclasses because we have reached the top of the class hierarchy.
</span><span style=color:#75715e></span>0x77<span style=color:#f92672>,</span>                                                                   <span style=color:#75715e>//TC_BLOCKDATA
</span><span style=color:#75715e></span>0x08<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x66<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xdf<span style=color:#f92672>,</span> 0x6e<span style=color:#f92672>,</span>
0x1e<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x78<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 
0x71<span style=color:#f92672>,</span> 
0x00<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x03<span style=color:#f92672>,</span>                                                 <span style=color:#75715e>// 3번 째 참조..?
</span><span style=color:#75715e></span>0x77<span style=color:#f92672>,</span> 
0x08<span style=color:#f92672>,</span>0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xd5<span style=color:#f92672>,</span> 0x17<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x22<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 
0x78 <span style=color:#f92672>};</span>
</code></pre></div><p><a href=https://docs.oracle.com/javase/7/docs/platform/serialization/spec/protocol.html>오라클 스펙</a></p>
<p><a href=https://www.javaworld.com/article/2072752/the-java-serialization-algorithm-revealed.html>serialization 알고리즘 참조</a></p>
<h2 id=규칙77-개체-통제가-필요하다면-readresolve-대신-enum-자료형을-사용해라>
규칙77 개체 통제가 필요하다면 readResolve 대신 enum 자료형을 사용해라
<a class=anchor href=#%ea%b7%9c%ec%b9%9977-%ea%b0%9c%ec%b2%b4-%ed%86%b5%ec%a0%9c%ea%b0%80-%ed%95%84%ec%9a%94%ed%95%98%eb%8b%a4%eb%a9%b4-readresolve-%eb%8c%80%ec%8b%a0-enum-%ec%9e%90%eb%a3%8c%ed%98%95%ec%9d%84-%ec%82%ac%ec%9a%a9%ed%95%b4%eb%9d%bc>#</a>
</h2>
<p>앞서 다룬 싱글톤 패턴은 &ldquo;implements Serializable&rdquo; 을 붙이는 순간 깨진다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Elvis</span> <span style=color:#f92672>{</span>
   <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Elvis INSTANCE <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Elvis<span style=color:#f92672>();</span>
   <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Elvis</span><span style=color:#f92672>(){}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul>
<li>기본 직렬화 형태, 사용자 정의 직렬화 형태 상관 없이</li>
<li>클래스에 명시적 readObject 있든 없든 상관 없다</li>
<li>모든 readObject 메서드는 새로 생성된 객체를 반환하는데 이 객체는 클래스가 초기화될 때 만들었던 객체가 아니다</li>
</ul>
<h3 id=readresove-통한-싱글톤>
readResove 통한 싱글톤
<a class=anchor href=#readresove-%ed%86%b5%ed%95%9c-%ec%8b%b1%ea%b8%80%ed%86%a4>#</a>
</h3>
<p>readResolve 는 역직렬화 끝나서 만들어진 객체에 대해 호출된다. 새로 만들어진 객체 대신 이 메서드가 반환하는 객체가 사용자에게 간다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Elvis</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Elvis INSTANCE <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Elvis<span style=color:#f92672>();</span>
    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Elvis</span><span style=color:#f92672>(){}</span>

    <span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>readResolve</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> INSTANCE<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul>
<li>역직렬화된 객체는 무시. 싱글톤 객체 그냥 반환함</li>
<li>따라서 객체의 모든 필드는 transient 어야 한다</li>
<li>개체 통제를 위해 readResolve 쓸 때는 모든 객체 필드를 transient로 해야 한다
안 그러면 MutablePeriod 처럼 참조 가로채기 가능</li>
</ul>
<h3 id=비-transient-필드-통한-참조-가로채기>
비-transient 필드 통한 참조 가로채기
<a class=anchor href=#%eb%b9%84-transient-%ed%95%84%eb%93%9c-%ed%86%b5%ed%95%9c-%ec%b0%b8%ec%a1%b0-%ea%b0%80%eb%a1%9c%ec%b1%84%ea%b8%b0>#</a>
</h3>
<p>싱글톤 객체에 비-transient 필드가 있는 경우, 해당 필드의 내용은 객체의 readResolve가 실행되기 전에 역직렬화 되어야 한다.
따라서 이 부분을 바이트 스트림 조작을 통해 다른 객체로 갈아 끼면, 참조 필드가 역직렬화 되는 순간 원래 객체를 &ldquo;훔칠 수&rdquo; 있다. (원래는 참조를 잃고 GC 되어야 할&mldr;)</p>
<ul>
<li>먼저 도둑이 숨을 직렬화된 싱글턴 객체를 참조하는 객체 필드와 readResolve 메서드를 갖춘 도둑 클래스를 만듬</li>
<li>직렬화 스트림에서 싱글턴의 비-transient 필드가 참조하는 대상을 도둑 객체로 바꿔놓는다</li>
<li>이러면 참조 순환이 발생함(싱글턴은 도둑객체 포함, 도둑객체는 싱글턴 참조)</li>
<li>싱글턴이 도둑객체 포함하므로 싱글턴 역직렬화될 때 도둑 객체의 readResolve() 가 먼저 실행됨.</li>
<li>이 때 싱글톤 객체의 참조를 static 필드에 복사한다</li>
<li>그 다음 원래 대로 도둑 객체 숨겼던 원래 필드 자료형에 맞는 값을 반환한다. 안 그러면 ClassCastExecption 발생</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// 잘못된 싱글톤
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Elvis</span> <span style=color:#66d9ef>implements</span> Serializable <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Elvis INSTANCE <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Elvis<span style=color:#f92672>();</span>
    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>Elvis</span><span style=color:#f92672>(){}</span>

    <span style=color:#66d9ef>private</span> String<span style=color:#f92672>[]</span> favoriteSongs <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;Hound Dog&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Heartbreak Hotel&#34;</span><span style=color:#f92672>};</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>printFavorites</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(</span>favoriteSongs<span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>readResolve</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> INSTANCE<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//도둑 클래스
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ElvisStealer</span> <span style=color:#66d9ef>implements</span>  Serializable <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>static</span> Elvis impersonator<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> Elvis payload<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>readResolve</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// 아직 relosve 되지 않은 Elvis 객체 저장
</span><span style=color:#75715e></span>        impersonator <span style=color:#f92672>=</span> payload<span style=color:#f92672>;</span>

        <span style=color:#75715e>//favoriteSongs 필드 자료형에 맞는 객체 반환
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[]</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;A Fool Such as I&#34;</span><span style=color:#f92672>};</span>
    <span style=color:#f92672>}</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> serialVersionUID <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ElvisImpersonator</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> serializedForm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]{</span>
            <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xac<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xed<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x05<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x05<span style=color:#f92672>,</span> 0x45<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0x84<span style=color:#f92672>,</span>
            <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xe6<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0x93<span style=color:#f92672>,</span> 0x33<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xc3<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0xf4<span style=color:#f92672>,</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> 0x8b<span style=color:#f92672>,</span> 0x32<span style=color:#f92672>,</span> 0x02<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x01<span style=color:#f92672>,</span> 0x4c<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span>
            0x0d<span style=color:#f92672>,</span> 0x66<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x6f<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x53<span style=color:#f92672>,</span> 0x6f<span style=color:#f92672>,</span> 0x6e<span style=color:#f92672>,</span> 0x67<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x12<span style=color:#f92672>,</span> 0x4c<span style=color:#f92672>,</span>
            0x6a<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x2f<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x6e<span style=color:#f92672>,</span> 0x67<span style=color:#f92672>,</span> 0x2f<span style=color:#f92672>,</span> 0x4f<span style=color:#f92672>,</span> 0x62<span style=color:#f92672>,</span> 0x6a<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x63<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x3b<span style=color:#f92672>,</span> 0x78<span style=color:#f92672>,</span>
            0x70<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x0c<span style=color:#f92672>,</span> 0x45<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x53<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x65<span style=color:#f92672>,</span> 0x72<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span>
            0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x02<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x01<span style=color:#f92672>,</span> 0x4c<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x07<span style=color:#f92672>,</span> 0x70<span style=color:#f92672>,</span> 0x61<span style=color:#f92672>,</span> 0x79<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x6f<span style=color:#f92672>,</span>
            0x61<span style=color:#f92672>,</span> 0x64<span style=color:#f92672>,</span> 0x74<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x07<span style=color:#f92672>,</span> 0x4c<span style=color:#f92672>,</span> 0x45<span style=color:#f92672>,</span> 0x6c<span style=color:#f92672>,</span> 0x76<span style=color:#f92672>,</span> 0x69<span style=color:#f92672>,</span> 0x73<span style=color:#f92672>,</span> 0x3b<span style=color:#f92672>,</span> 0x78<span style=color:#f92672>,</span> 0x70<span style=color:#f92672>,</span> 0x71<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x7e<span style=color:#f92672>,</span> 0x00<span style=color:#f92672>,</span> 0x02
    <span style=color:#f92672>};</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Object <span style=color:#a6e22e>deserialize</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> sf<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            InputStream is <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ByteArrayInputStream<span style=color:#f92672>(</span>sf<span style=color:#f92672>);</span>
            ObjectInputStream ois <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ObjectInputStream<span style=color:#f92672>(</span>is<span style=color:#f92672>);</span>
            <span style=color:#66d9ef>return</span> ois<span style=color:#f92672>.</span><span style=color:#a6e22e>readObject</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalArgumentException<span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#75715e>// ElvisStealer.impersonator 를 초기화 하고
</span><span style=color:#75715e></span>        <span style=color:#75715e>// 진짜 Elvis 객체를 반환 한다 (Elvis.INSTANCE)
</span><span style=color:#75715e></span>        Elvis elvis <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>Elvis<span style=color:#f92672>)</span> deserialize<span style=color:#f92672>(</span>serializedForm<span style=color:#f92672>);</span>
        Elvis impersonator <span style=color:#f92672>=</span> ElvisStealer<span style=color:#f92672>.</span><span style=color:#a6e22e>impersonator</span><span style=color:#f92672>;</span>
        
        elvis<span style=color:#f92672>.</span><span style=color:#a6e22e>printFavorites</span><span style=color:#f92672>();</span>
        impersonator<span style=color:#f92672>.</span><span style=color:#a6e22e>printFavorites</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>//[Hound Dog, Heartbreak Hotel]
</span><span style=color:#75715e></span>    <span style=color:#75715e>//[A Fool Such as I]
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><h3 id=해결책>
해결책
<a class=anchor href=#%ed%95%b4%ea%b2%b0%ec%b1%85>#</a>
</h3>
<p>대신 직력화 가능 클래스를 enum 으로 구현하면 확실히 싱글톤 보장이 됨.
JVM이 보장해주고 프로그래머는 신경 쓸 필요 없음.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> Elvis <span style=color:#f92672>{</span>
    INSTANCE<span style=color:#f92672>;</span>
    privates String<span style=color:#f92672>[]</span> favoriteSongs <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;Hound Dog&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Heartbreak Hotel&#34;</span><span style=color:#f92672>};</span>
    <span style=color:#75715e>//...
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><p>하지만 직렬화 가능 클래스의 객체수를 컴파일 시점에서 알 수 없는 경우 enum을 통해 구현 할 수 없음. readResolve 써야함</p>
<h3 id=readresove와-접근-권한>
readResove와 접근 권한
<a class=anchor href=#readresove%ec%99%80-%ec%a0%91%ea%b7%bc-%ea%b6%8c%ed%95%9c>#</a>
</h3>
<ul>
<li>readResolve 메서드를 final 클래스에 두는 경우엔 반드시 private으로 선언해야 한다.</li>
<li>final 클래스가 아닐 때, readResolve가 private이면 하위 클래스에는 적용되지 않는다.</li>
<li>final 클래스가 아닐 때, readResolve가 protected나 public이면, readResolve를 재정의하지 않은 모든 하위 클래스에 적용이 될 텐데 이러면 직렬화된 하위 클래스 객체를 deserialize 하면 상위 클래스 객체가 만들어져 ClassCastException이 발생할 것이다.</li>
</ul>
<h3 id=요약-1>
요약
<a class=anchor href=#%ec%9a%94%ec%95%bd-1>#</a>
</h3>
<ul>
<li>개체 수 관련 불변식 강제하고 싶으면 enum 쓰자</li>
<li>그런 상황이 아니면 반드시 readResolve 를 구현해야하고 모든 객체 필드는 기본 자료형이나 transient로 선언해야 한다.</li>
</ul>
<h2 id=규칙78-직렬화된-객체-대신-직렬화-프락시를-고려해-보라>
규칙78 직렬화된 객체 대신 직렬화 프락시를 고려해 보라
<a class=anchor href=#%ea%b7%9c%ec%b9%9978-%ec%a7%81%eb%a0%ac%ed%99%94%eb%90%9c-%ea%b0%9d%ec%b2%b4-%eb%8c%80%ec%8b%a0-%ec%a7%81%eb%a0%ac%ed%99%94-%ed%94%84%eb%9d%bd%ec%8b%9c%eb%a5%bc-%ea%b3%a0%eb%a0%a4%ed%95%b4-%eb%b3%b4%eb%9d%bc>#</a>
</h2>
<p>직렬화를 사용하면 버그나 보안 결함 생길 가능성 높음
일반 생성자 대신 언어 외적인 매커니즘을 이용하기 때문</p>
<p>이에 대안으로 <code>직렬화 프록시 패턴</code>이 있다.</p>
<ul>
<li>private static nested class (== serialization proxy)를 만든다. (outer class 객체의 논리적 상태를 간결하게 표현하는)</li>
<li>바깥 클래스를 인자 자료형으로 사용하는 생성자 하나 (일관성 검사 필요 없음, 방어적 복사 필요 없음)</li>
<li>바깥 클래스에 writeReplace 메서드 구현</li>
<li>proxy 클래스에 자기와 논리적으로 동일한 바깥 클래스객체 반환하는 readResolve 메서드 추가</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SerializationProxy</span> <span style=color:#66d9ef>implements</span> Serializable <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Date start<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Date end<span style=color:#f92672>;</span>

    SerializationProxy<span style=color:#f92672>(</span>Period p<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>end</span> <span style=color:#f92672>=</span> p<span style=color:#f92672>.</span><span style=color:#a6e22e>end</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> serialVersionUID <span style=color:#f92672>=</span> 1241142L<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>다음과 같이 바깥 클래스에 writeReplace() 구현하면 직렬화 시스템은 바깥 클래스를 직렬화된 객체 만들지 않음</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>writeReplace</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> SerializationProxy<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>근데 공격자는 앞선 바이트스트림 공격처럼 만드려 시도 할 수 있다. 그걸 막으려면 readObject를 바깥 클래스에 추가하면 된다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>readObject</span><span style=color:#f92672>(</span>ObjectInputStream stream<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InvalidObjectException <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> InvalidObjectException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Proxy require!&#34;</span><span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>마지막으로 SerializationProxy 클래스에 readResolve를 추가.
Public API만 이용하기 때문에 아름답다. (직렬화 특성 거의 제거)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>readResolve</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Period<span style=color:#f92672>(</span>start<span style=color:#f92672>,</span> end<span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>장점</p>
<ol>
<li>방어적 복사 접근법 처럼 바이트 스트림 통한 공격 방지</li>
<li>내부 필드 탈취 공격도 저절로 중단</li>
<li>외부 클래스 필드를 final로 선언할 수 있어서 진정한 immutable class 구현 가능</li>
<li>직렬화 도중 유효성 검사도 필요 없음</li>
<li>역직렬화된 객체가 애초에 직렬화된 객체와 다른 클래스가 되도록 할 수 있음(?? 장점인가..??)</li>
</ol>
<p>EnumSet의 경우 생성자가 없고 팩토리 메서드로 EnumSet 객체를 얻는데, 실제로는 자료형 크기가 64 이하면 RegularEnumSet,
64 보다 크면 JumboEnumSet을 반환한다. 만약 64개 원소를 갖는 enumSet 객체를 직렬화 한다음 enum 자료형에 다섯 개의 원소를 더 추가하고,
방금 직렬화한 객체를 역직렬화 하면? 처음엔 RegularEnumSet Type 이었겠지만 나중엔 JumboEnumSet Type으로 변환 될 것이다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// EnumSet 의 직렬화 프록시
</span><span style=color:#75715e>// EnumSet&#39;s serialization proxy
</span><span style=color:#75715e></span>   <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SerializationProxy</span> <span style=color:#f92672>&lt;</span>E <span style=color:#66d9ef>extends</span> Enum<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;&gt;</span>
           <span style=color:#66d9ef>implements</span> Serializable <span style=color:#f92672>{</span>
       <span style=color:#75715e>// The element type of this enum set.
</span><span style=color:#75715e></span>       <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Class<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> elementType<span style=color:#f92672>;</span>

       <span style=color:#75715e>// The elements contained in this enum set.
</span><span style=color:#75715e></span>       <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Enum<span style=color:#f92672>[]</span> elements<span style=color:#f92672>;</span>

       SerializationProxy<span style=color:#f92672>(</span>EnumSet<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> set<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
           elementType <span style=color:#f92672>=</span> set<span style=color:#f92672>.</span><span style=color:#a6e22e>elementType</span><span style=color:#f92672>;</span>
           elements <span style=color:#f92672>=</span> set<span style=color:#f92672>.</span><span style=color:#a6e22e>toArray</span><span style=color:#f92672>(</span>EMPTY_ENUM_ARRAY<span style=color:#f92672>);</span>  <span style=color:#75715e>// (Item 43)
</span><span style=color:#75715e></span>       <span style=color:#f92672>}</span>

       <span style=color:#66d9ef>private</span> Object <span style=color:#a6e22e>readResolve</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
           EnumSet<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> result <span style=color:#f92672>=</span> EnumSet<span style=color:#f92672>.</span><span style=color:#a6e22e>noneOf</span><span style=color:#f92672>(</span>elementType<span style=color:#f92672>);</span>
           <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Enum e <span style=color:#f92672>:</span> elements<span style=color:#f92672>)</span>
               result<span style=color:#f92672>.</span><span style=color:#a6e22e>add</span><span style=color:#f92672>((</span>E<span style=color:#f92672>)</span>e<span style=color:#f92672>);</span>
           <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
       <span style=color:#f92672>}</span>

       <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> serialVersionUID <span style=color:#f92672>=</span> 362491234563181265L<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#75715e>// 팩토리 메소드 내부
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#f92672>&lt;</span>E <span style=color:#66d9ef>extends</span> Enum<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;&gt;</span> EnumSet<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>noneOf</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;</span>E<span style=color:#f92672>&gt;</span> elementType<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Enum<span style=color:#f92672>&lt;?&gt;[]</span> universe <span style=color:#f92672>=</span> getUniverse<span style=color:#f92672>(</span>elementType<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>universe <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ClassCastException<span style=color:#f92672>(</span>elementType <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; not an enum&#34;</span><span style=color:#f92672>);</span>

        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>universe<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>&lt;=</span> 64<span style=color:#f92672>)</span>
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> RegularEnumSet<span style=color:#f92672>&lt;&gt;(</span>elementType<span style=color:#f92672>,</span> universe<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>else</span>
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> JumboEnumSet<span style=color:#f92672>&lt;&gt;(</span>elementType<span style=color:#f92672>,</span> universe<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
</code></pre></div><h3 id=직렬화-프록시-단점>
직렬화 프록시 단점
<a class=anchor href=#%ec%a7%81%eb%a0%ac%ed%99%94-%ed%94%84%eb%a1%9d%ec%8b%9c-%eb%8b%a8%ec%a0%90>#</a>
</h3>
<ul>
<li>클라이언트가 확장할 수 있는 클래스에는 적용 불가.</li>
<li>객체 그래프에 순환이 있으면 사용 불가. 어떤 객체의 메서드를 해당 객체의 직렬화 프록시의 readResolve 에서 호출하면 ClassCastException 이 뜬다. 아직 실제 객체를 가진것이 아니기 때문.</li>
<li>직렬화 프고시는 방어적 복사 기법에 비해 비용이 더 많이 듬</li>
</ul>
<h3 id=요약-2>
요약
<a class=anchor href=#%ec%9a%94%ec%95%bd-2>#</a>
</h3>
<ul>
<li>클라이언트가 확장할 수 없는 클래스에 readObject나 writeObject를 구현해야 할 때는 직렬화 프록시 패턴 도입을 고려. 단순하지 않은 불변식을 만족해야 하는 객체를 안정적으로 직렬화하는 가장 쉬운 방법</li>
</ul>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#규칙-76-readobject-메서드는-방어적으로-구현하라>규칙 76 readObject 메서드는 방어적으로 구현하라</a>
<ul>
<li><a href=#immutable-class>immutable class</a></li>
<li><a href=#방어-규칙>방어 규칙</a></li>
<li><a href=#공격1-악의적인-바이트-스트림-공격>공격1. 악의적인 바이트 스트림 공격</a></li>
<li><a href=#해결책1-readobject에서-유효성-검사-구현>해결책1. readObject에서 유효성 검사 구현</a></li>
<li><a href=#공격2-악의적-객체-참조>공격2. 악의적 객체 참조</a></li>
<li><a href=#해결책2-방어적-복사>해결책2 방어적 복사</a></li>
<li><a href=#요약>요약</a></li>
</ul>
</li>
<li><a href=#규칙77-개체-통제가-필요하다면-readresolve-대신-enum-자료형을-사용해라>규칙77 개체 통제가 필요하다면 readResolve 대신 enum 자료형을 사용해라</a>
<ul>
<li><a href=#readresove-통한-싱글톤>readResove 통한 싱글톤</a></li>
<li><a href=#비-transient-필드-통한-참조-가로채기>비-transient 필드 통한 참조 가로채기</a></li>
<li><a href=#해결책>해결책</a></li>
<li><a href=#readresove와-접근-권한>readResove와 접근 권한</a></li>
<li><a href=#요약-1>요약</a></li>
</ul>
</li>
<li><a href=#규칙78-직렬화된-객체-대신-직렬화-프락시를-고려해-보라>규칙78 직렬화된 객체 대신 직렬화 프락시를 고려해 보라</a>
<ul>
<li><a href=#직렬화-프록시-단점>직렬화 프록시 단점</a></li>
<li><a href=#요약-2>요약</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>