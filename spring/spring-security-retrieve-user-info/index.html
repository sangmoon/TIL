<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="스프링 공부하자">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Spring">
<meta property="og:description" content="스프링 공부하자">
<meta property="og:type" content="article">
<meta property="og:url" content="https://sangmoon.github.io/TIL/spring/spring-security-retrieve-user-info/"><meta property="article:section" content="Spring">
<meta property="article:published_time" content="2021-10-23T00:00:00+00:00">
<meta property="article:modified_time" content="2021-10-23T00:00:00+00:00">
<title>Spring | Sangmoon's TIL</title>
<link rel=manifest href=/TIL/manifest.json>
<link rel=icon href=/TIL/favicon.png type=image/x-icon>
<link rel=stylesheet href=/TIL/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous>
<script defer src=/TIL/flexsearch.min.js></script>
<script defer src=/TIL/en.search.min.58e317a58bdb983ff9fe64dbce44994883782a83ea5a5d5fbf080e12279c4e0f.js integrity="sha256-WOMXpYvbmD/5/mTbzkSZSIN4KoPqWl1fvwgOEiecTg8=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/TIL/><span>Sangmoon's TIL</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/TIL/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Spring</strong>
<label for=toc-control>
<img src=/TIL/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents></nav>
</aside>
</header>
<article class=markdown><p>2018/01/25</p>
<h1 id=스프링-시큐리티로-유저-정보-얻기>
스프링 시큐리티로 유저 정보 얻기!
<a class=anchor href=#%ec%8a%a4%ed%94%84%eb%a7%81-%ec%8b%9c%ed%81%90%eb%a6%ac%ed%8b%b0%eb%a1%9c-%ec%9c%a0%ec%a0%80-%ec%a0%95%eb%b3%b4-%ec%96%bb%ea%b8%b0>#</a>
</h1>
<ol>
<li>Bean으로 부터 유저 정보 얻기
<code>SecurityConytextHolder</code> 로 부터 현재 인증된 principal을 얻을 수 있다.</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Authentication authentication <span style=color:#f92672>=</span> SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>();</span>
String currentPrincipalName <span style=color:#f92672>=</span> authentication<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>	
</code></pre></div><p>체크하기 전에 유저가 있는지 체크할 수 있다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Authentication authentication <span style=color:#f92672>=</span> SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>();</span>
<span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>authentication <span style=color:#66d9ef>instanceof</span> AnonymousAuthenticationToken<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
    String currentUserName <span style=color:#f92672>=</span> authentication<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
    <span style=color:#66d9ef>return</span> currentUserName<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>하지만 static call은 좋지 않다&mldr;</p>
<ol start=2>
<li>컨트롤러에서는 <code>(@Controller)</code> 추가적인 방법이 가능하다. <code>Principal</code> 에 method argument로 접근이 가능하다.</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.security.Principal<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.stereotype.Controller<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMapping<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMethod<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.ResponseBody<span style=color:#f92672>;</span>
 
<span style=color:#a6e22e>@Controller</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityController</span> <span style=color:#f92672>{</span>
 
    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/username&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@ResponseBody</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>currentUserName</span><span style=color:#f92672>(</span>Principal principal<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> principal<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p><code>authentication</code> token 으로 접근 할 수도 있다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> org.springframework.security.core.Authentication<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.stereotype.Controller<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMapping<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMethod<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.ResponseBody<span style=color:#f92672>;</span>
 
<span style=color:#a6e22e>@Controller</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityController</span> <span style=color:#f92672>{</span>
 
    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/username&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@ResponseBody</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>currentUserName</span><span style=color:#f92672>(</span>Authentication authentication<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> authentication<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>HTTP request로 부터 직접 접근도 가능하다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> java.security.Principal<span style=color:#f92672>;</span>
 
<span style=color:#f92672>import</span> javax.servlet.http.HttpServletRequest<span style=color:#f92672>;</span>
 
<span style=color:#f92672>import</span> org.springframework.stereotype.Controller<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMapping<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.RequestMethod<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.springframework.web.bind.annotation.ResponseBody<span style=color:#f92672>;</span>
 
<span style=color:#a6e22e>@Controller</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityController</span> <span style=color:#f92672>{</span>
 
    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/username&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@ResponseBody</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>currentUserNameSimple</span><span style=color:#f92672>(</span>HttpServletRequest request<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Principal principal <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span><span style=color:#a6e22e>getUserPrincipal</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>return</span> principal<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ol start=3>
<li>Spring의 DI를 이용하면 컨트롤러가 아니어도 어디서든 접근이 가능하다! 이를 위해 간단한 인터페이스를 구성하자.</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>IAuthenticationFacade</span> <span style=color:#f92672>{</span>
    Authentication <span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>();</span>
<span style=color:#f92672>}</span>
<span style=color:#a6e22e>@Component</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthenticationFacade</span> <span style=color:#66d9ef>implements</span> IAuthenticationFacade <span style=color:#f92672>{</span>
 
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Authentication <span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> SecurityContextHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>getContext</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>DI를 활용해 다음과 같이 decoupled 시켜서 스프링의 장점을 활용할 수 있다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Controller</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecurityController</span> <span style=color:#f92672>{</span>
    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> IAuthenticationFacade authenticationFacade<span style=color:#f92672>;</span>
 
    <span style=color:#a6e22e>@RequestMapping</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/username&#34;</span><span style=color:#f92672>,</span> method <span style=color:#f92672>=</span> RequestMethod<span style=color:#f92672>.</span><span style=color:#a6e22e>GET</span><span style=color:#f92672>)</span>
    <span style=color:#a6e22e>@ResponseBody</span>
    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>currentUserNameSimple</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        Authentication authentication <span style=color:#f92672>=</span> authenticationFacade<span style=color:#f92672>.</span><span style=color:#a6e22e>getAuthentication</span><span style=color:#f92672>();</span>
        <span style=color:#66d9ef>return</span> authentication<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ol start=4>
<li>JSP 에서는 어떻게 가져오지?
현재 인증 정보는 JSP에서 접근 할 수도 있다.
우선 <code>spring-security-taglib</code>를 pom.xml에 추가하고</li>
</ol>
<pre tabindex=0><code class=language-jsp data-lang=jsp>&lt;%@ taglib prefix=&quot;security&quot; uri=&quot;http://www.springframework.org/security/tags&quot; %&gt;
</code></pre><p>라고 jsp에 include하면 된다.</p>
<pre tabindex=0><code class=language-jsp data-lang=jsp>&lt;security:authorize access=&quot;isAuthenticated()&quot;&gt;
    authenticated as &lt;security:authentication property=&quot;principal.username&quot; /&gt; 
&lt;/security:authorize&gt;
</code></pre><p>그러면 위와 같이 접근 할 수 있다.</p>
<p>다음 두 곳을 참조하였다.</p>
<p><a href=http://www.baeldung.com/get-user-in-spring-security>Baeldung</a></p>
<p><a href=https://github.com/eugenp/tutorials/tree/master/spring-security-rest-custom#readme>github-project</a></p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents></nav>
</div>
</aside>
</main>
</body>
</html>