<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="자바 메모리 모델에 대해 알아보자">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Java memory model">
<meta property="og:description" content="자바 메모리 모델에 대해 알아보자">
<meta property="og:type" content="article">
<meta property="og:url" content="https://sangmoon.github.io/TIL/concurrency/ch16_java_memory_model/"><meta property="article:section" content="Concurrency">
<meta property="article:published_time" content="2021-10-23T08:47:11+01:00">
<meta property="article:modified_time" content="2021-10-23T08:47:11+01:00">
<title>Java memory model | Sangmoon's TIL</title>
<link rel=manifest href=/TIL/manifest.json>
<link rel=icon href=/TIL/favicon.png type=image/x-icon>
<link rel=stylesheet href=/TIL/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous>
<script defer src=/TIL/flexsearch.min.js></script>
<script defer src=/TIL/en.search.min.58e317a58bdb983ff9fe64dbce44994883782a83ea5a5d5fbf080e12279c4e0f.js integrity="sha256-WOMXpYvbmD/5/mTbzkSZSIN4KoPqWl1fvwgOEiecTg8=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/TIL/><span>Sangmoon's TIL</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/TIL/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Java memory model</strong>
<label for=toc-control>
<img src=/TIL/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#161-자바-메모리-모델은-무엇이며-왜-사용해야-할까>16.1 자바 메모리 모델은 무엇이며, 왜 사용해야 할까?</a>
<ul>
<li><a href=#1611-플랫폼-메모리-모델>16.1.1 플랫폼 메모리 모델</a></li>
<li><a href=#1612-재배치>16.1.2 재배치</a></li>
<li><a href=#1613-자바-메모리-모델을-간략히-설명한다면>16.1.3 자바 메모리 모델을 간략히 설명한다면</a></li>
<li><a href=#1614-동기화-피기백>16.1.4 동기화 피기백</a></li>
</ul>
</li>
<li><a href=#162-안전한-공개>16.2 안전한 공개</a></li>
<li><a href=#1621-안전하지-못한-공개>16.2.1 안전하지 못한 공개</a></li>
<li><a href=#1622-안전한-공개>16.2.2 안전한 공개</a>
<ul>
<li><a href=#1623-안전한-초기화를-위한-구문>16.2.3 안전한 초기화를 위한 구문</a></li>
<li><a href=#1624-double-checked-lock>16.2.4 Double Checked Lock</a></li>
</ul>
</li>
<li><a href=#163-초기화-안전성>16.3 초기화 안전성</a></li>
<li><a href=#요약>요약</a></li>
</ul>
</nav>
</aside>
</header>
<article class=markdown><h1 id=ch16-자바-메모리-모델>
ch16 자바 메모리 모델
<a class=anchor href=#ch16-%ec%9e%90%eb%b0%94-%eb%a9%94%eb%aa%a8%eb%a6%ac-%eb%aa%a8%eb%8d%b8>#</a>
</h1>
<h2 id=161-자바-메모리-모델은-무엇이며-왜-사용해야-할까>
16.1 자바 메모리 모델은 무엇이며, 왜 사용해야 할까?
<a class=anchor href=#161-%ec%9e%90%eb%b0%94-%eb%a9%94%eb%aa%a8%eb%a6%ac-%eb%aa%a8%eb%8d%b8%ec%9d%80-%eb%ac%b4%ec%97%87%ec%9d%b4%eb%a9%b0-%ec%99%9c-%ec%82%ac%ec%9a%a9%ed%95%b4%ec%95%bc-%ed%95%a0%ea%b9%8c>#</a>
</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//특정 쓰레드에서 변수에 값을 할당
</span><span style=color:#75715e></span>aVailable <span style=color:#f92672>=</span> 3<span style=color:#f92672>;</span>
</code></pre></div><p>자바 메모리 모델: &ldquo;쓰레드가 aVariable에 할당도니 3이란 값을 사용할 수 있으려면 어떤 조건이 돼야 하는가?&rdquo;
동기화 기법을 사용하지 않으면, 영언히 3을 읽어가지 못하는 여러 상황 존재.</p>
<ul>
<li>컴파일러에서 소스코드에 적힌 내용을 명확하게 구현하는 코드를 생성 못할 가능성</li>
<li>변수 값을 메모리가 아닌 CPU 레지스터에 보관할 수 있음</li>
<li>CPU 프로세서는 프로그램을 순차실행 하거나, 병렬 실행할 수 있고 따라서 사용하는 캐시 형태에 다라 할당된 값이 메모리에 보관되는 시점에 차이가 있을 수 있으며 CPU 내부 캐시 값이 다른 CPU에는 안 보일 수 있다.</li>
</ul>
<p>싱글 쓰레드 일 때는 이런 현상이 가려져 보이지 않음. JVM 명세에 싱글 스레드 일 경우, 순차실행과 같은 결과를 보장하도록 하고 있음. 결과만 같으면 어떤 식으로 하든 상관없음.</p>
<h3 id=1611-플랫폼-메모리-모델>
16.1.1 플랫폼 메모리 모델
<a class=anchor href=#1611-%ed%94%8c%eb%9e%ab%ed%8f%bc-%eb%a9%94%eb%aa%a8%eb%a6%ac-%eb%aa%a8%eb%8d%b8>#</a>
</h3>
<ul>
<li>메모리 공유 멀티 프로세서 시스템은 보통 프로세서 내에 캐시가 있음</li>
<li>캐시의 내용을 주기적으로 메인 메모리와 동기화</li>
<li>하드웨어 프로세서 아키텍처는 저마다 다른 캐시 일관성(cache coherence)를 지원</li>
<li>멀티 프로세서에서 모두 동기화처리하는 것은 부하가 큼. 대부분 성능을 위해 캐시 일관성을 일부 포기함.</li>
<li>시스템 구조의 메모리 모델은 기본 정보를 제공하고, 메모리 내용을 공유하고자 할 때 특별한 명령어(memory barrier나 fence) 를 어떻게 사용해야 하는지 제공</li>
<li>자바 개발자가 하드웨어 신경 쓰지 않도록 JVM은 JMM(java memory model) 을 통해 이를 추상화.</li>
</ul>
<h3 id=1612-재배치>
16.1.2 재배치
<a class=anchor href=#1612-%ec%9e%ac%eb%b0%b0%ec%b9%98>#</a>
</h3>
<ul>
<li>JMM은 서로 다른 쓰레드가 각자 상황에 맞게 명령어를 실행할 수 있도록 허용</li>
<li>동기화되지 않은 부분의 실행 순서 예측은 힘듬</li>
<li>특정 작업이 지연되거나 다른 순서로 실행되는 것처럼 보이는 문제는 <code>재배치(reorder)</code> 로 표현</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>//예제16.1
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PossibleReordering</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> x <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> y <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> a <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> b <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException <span style=color:#f92672>{</span>
        Thread one <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>(){</span>
            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                a <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
                x <span style=color:#f92672>=</span> b<span style=color:#f92672>;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>
        Thread other <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Runnable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                b <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span>
                y <span style=color:#f92672>=</span> a<span style=color:#f92672>;</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>

        one<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        one<span style=color:#f92672>.</span><span style=color:#a6e22e>joint</span><span style=color:#f92672>();</span> other<span style=color:#f92672>.</span><span style=color:#a6e22e>join</span><span style=color:#f92672>();</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span>x <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; , &#34;</span> <span style=color:#f92672>+</span> y<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>결과 예측은 어려움. (1,0) (0,1) (1,1) (0,0) 다 가능</p>
<h3 id=1613-자바-메모리-모델을-간략히-설명한다면>
16.1.3 자바 메모리 모델을 간략히 설명한다면
<a class=anchor href=#1613-%ec%9e%90%eb%b0%94-%eb%a9%94%eb%aa%a8%eb%a6%ac-%eb%aa%a8%eb%8d%b8%ec%9d%84-%ea%b0%84%eb%9e%b5%ed%9e%88-%ec%84%a4%eb%aa%85%ed%95%9c%eb%8b%a4%eb%a9%b4>#</a>
</h3>
<ul>
<li>JMM 은 프로그램 내부 모든 작업을 대상으로 <code>미리 발생(happens-before)</code> 라는 <code>부분 재배치(partial reordering)</code> 연산을 정의</li>
<li>작업 A가 실행된 결과를 작업B에서 볼수 있다는 점을 보장하기 위해(동일 쓰레드는 다른 쓰레드든) 작업 A와 작업B 사이에는 미리 발생 관계가 갖춰져야 한다</li>
<li>관계가 없아면 JVM은 지멋대로 작업을 재배치</li>
<li>하나의 변수를 2개이상 쓰레드가 읽고, 최소 하나 이상 쓰레드에서 쓰기 작업을 하는데 미리 발생 관계가 갖춰져 있지 않다면 <code>데이터 경쟁(data race)</code> 가 발생</li>
<li>이런 데이터 경쟁이 발생하지 않는 프로그램을 <code>올바른 동기화 프로그램(correctly synchoronized program)</code> 이라고 함.</li>
</ul>
<blockquote>
<p>미리 발생 현상 규칙</p>
<blockquote>
<p><code>프로그램 순서 규칙</code>: 특정 스레드를 놓고 봤을 때 프로그램된 순서에서 앞서 있는 작업은 동일 스레드에서 뒤에 실행되도록 프로그램된 작업보다 미리 발생한다<br>
<code>모니터 잠금 규칙</code>: 특정 모니터 잠금 작업이 뒤이어 오는 모든 모니터 잠근 작업보다 미리 발생한다<br>
<code>volatile 변수 규칙</code>: volatile 변수에 대한 쓰기 작업은 이후에 따라오는 해당 변수에 대한 모든 읽기 작업보다 미리 발생한다<br>
<code>쓰레드 시작 규칙</code>: 특정 스레드에 대한 Thread.start 작업은 시작된 스레드가 갖고 있는 모든 작업보다 미리 발생한다<br>
<code>스레드 완료 규칙</code>: 스레드 내부의 모든 작업은 다른 스레드에서 해당 스레드가 완료됐다는점을 파악하는 시점보다 미리 발생한다. 특정 스레드가 완료됐는지 판단하는 것은 Thread.join 메소드가 리턴되거나 Thread.isAlive가 false를 리턴하는지 확인하는 방법을 말한다<br>
<code>인터럽트 규칙</code>: 다른 스레드를 대상으로 interrupt 메소드를 호출하는 작업은 인터럽트 당한 스레드에서 인터럽트를 당했다는 사실을 파악하는 일보다 미리 발생한다. 인터럽트를 당했다는 사실을 파악하려면 InterruptedException을 받거나 isInterrupted 메소드 또는 interrupted 메소드를 사용할 수 있다<br>
<code>완료 메소드(finalizer) 규칙</code>: 특정 객체에 대한 생성 메소드가 오나료되는 시점은 완료메소드가 시작하는 시점보다 미리 발생한다<br>
<code>전이성(transitivity)</code>: A가 B보다 미리 발생하고, B가 C보다 미리 발생한다면, A는 C보다 미리 발생한다</p>
</blockquote>
</blockquote>
<p>** 특정 Lock 객체 잠그거나 해제하는 연산은 암묵적락과 동일한 메모리 현상을 보여준다<br>
** 단일 연산 변수에 대한 읽기 쓰기 연산은 volatile 변수에 대한 작업과 동일한 메모리 현상을 보여준다.</p>
<p>작업이 부분적으로만 순서가 정해져 있어도, 동기화 작업(락 확보 및 해제, vilatile 변수 읽기 쓰기 작업)은 항상 완전하게 순서가 정해져 있다.</p>
<h3 id=1614-동기화-피기백>
16.1.4 동기화 피기백
<a class=anchor href=#1614-%eb%8f%99%ea%b8%b0%ed%99%94-%ed%94%bc%ea%b8%b0%eb%b0%b1>#</a>
</h3>
<ul>
<li>
<p><code>피기백(piggyback)</code>: 현재 사용 중인 동기화 기법의 가시성(visiblity)에 얹혀가는 방법 락으로 보호돼 있지 않은 변수에 모니터락이나 volatile 변수 규칙 같은 미리 발생 규칙을 함께 적용해 순서를 정의하는 방법. 오류가 나기 쉬워 성능 튜닝이 정말 중요할 때만 써야함</p>
</li>
<li>
<p>AQS는 FutureTask가 맡은 작업의 진행 상태(실행 중, 완료, 취소 여부를 정수형으로 보관) 및 결과 관리</p>
</li>
<li>
<p>외부에서는 set()으로 실행 결과를 보관하고, get()으로 결과 값을 가져옴</p>
</li>
<li>
<p>결과 값 보관 변수를 volatile로 선언해도 되겠지만, 기존 동기화 잘 이용하면 적은 자원으로 동일한 결과 얻을 수 있음</p>
</li>
<li>
<p>FutureTask 메소드에서 <code>tryReleaseShared()</code> 메소드가 <code>tryAcquireShared()</code> 보다 항상 먼저 실행되도록 되어 있음&mldr;</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// AbstractQueuedSynchronizer 내부
</span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> Thread runner<span style=color:#f92672>;</span>

<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>tryReleaseShared</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> ignore<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    runner <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>tryAcquireShared</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> ignore<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> innerIsDone<span style=color:#f92672>()</span> <span style=color:#f92672>?</span> 1 <span style=color:#f92672>:</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>innerIsDone</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> ranOrCancelled<span style=color:#f92672>(</span>getState<span style=color:#f92672>())</span> <span style=color:#f92672>&amp;&amp;</span> runner <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>innerSet() 은 releaseShared() 하기 전에 결과를 set 하고 innerGet()은 acquireShared() 하고 결과 얻어오므로&mldr; 락 없으나 result 쓰는 일이 result 읽는 것보다
먼저 일어나도록 조절하고 있음</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// FutureTask 내부의 AbstactQueuedSynchronizer class
</span><span style=color:#75715e></span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Sync</span> <span style=color:#66d9ef>extends</span> AbstactQueuedSynchorizer <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> RUNNING <span style=color:#f92672>=</span> 1<span style=color:#f92672>,</span> RAN <span style=color:#f92672>=</span> 2<span style=color:#f92672>,</span> CANCELLED <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> V result<span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> Exception exception<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>innnerSet</span><span style=color:#f92672>(</span>V v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>while</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>int</span> s <span style=color:#f92672>=</span> getState<span style=color:#f92672>();</span>
            <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>RanOrCancelled<span style=color:#f92672>(</span>s<span style=color:#f92672>))</span>
                <span style=color:#66d9ef>return</span><span style=color:#f92672>;</span>
            <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>compareAndSetState<span style=color:#f92672>(</span>s<span style=color:#f92672>,</span> RAN<span style=color:#f92672>))</span> 
                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
        <span style=color:#f92672>}</span>
        result <span style=color:#f92672>=</span> v<span style=color:#f92672>;</span>
        releaseShared<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
        done<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    V <span style=color:#a6e22e>innerGet</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>,</span> ExecutionException <span style=color:#f92672>{</span>
        acquireSharedInerruptibly<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>getState<span style=color:#f92672>()</span> <span style=color:#f92672>==</span> CANCELLED<span style=color:#f92672>)</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> CancellationException<span style=color:#f92672>();</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>exception <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> ExecutionException<span style=color:#f92672>(</span>exception<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>이처럼 객체 값 공개할 미리 발생 규칙 따로 정의하지 않고, 다른 목적으로 만들어 놓은 미리 발생 순서를 가져다가 사용하는 것을 피기백이라고 함</p>
<h2 id=162-안전한-공개>
16.2 안전한 공개
<a class=anchor href=#162-%ec%95%88%ec%a0%84%ed%95%9c-%ea%b3%b5%ea%b0%9c>#</a>
</h2>
<h2 id=1621-안전하지-못한-공개>
16.2.1 안전하지 못한 공개
<a class=anchor href=#1621-%ec%95%88%ec%a0%84%ed%95%98%ec%a7%80-%eb%aa%bb%ed%95%9c-%ea%b3%b5%ea%b0%9c>#</a>
</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnsafeLazyInitialization</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Resource resource<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Resource <span style=color:#a6e22e>getInstance</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>resource <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Resource<span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul>
<li>경쟁 조건 생길 수 있음</li>
<li>심한 경우, 참조는 최신화되지만 내부 초기화는 재배치 될 수 있음</li>
</ul>
<p>락을 쓰거나 volatile을 쓰면 미리 발생 관계가 보장됨..</p>
<h2 id=1622-안전한-공개>
16.2.2 안전한 공개
<a class=anchor href=#1622-%ec%95%88%ec%a0%84%ed%95%9c-%ea%b3%b5%ea%b0%9c>#</a>
</h2>
<h3 id=1623-안전한-초기화를-위한-구문>
16.2.3 안전한 초기화를 위한 구문
<a class=anchor href=#1623-%ec%95%88%ec%a0%84%ed%95%9c-%ec%b4%88%ea%b8%b0%ed%99%94%eb%a5%bc-%ec%9c%84%ed%95%9c-%ea%b5%ac%eb%ac%b8>#</a>
</h3>
<ul>
<li>Syncronized</li>
<li>Static (static 변수가 아니어도 static block에서 초기화하면 같은 효과)</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// 스레드 안전 초기화
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SafeLazyInitialization</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Resource resource<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>static</span> Resource <span style=color:#a6e22e>getInstance</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>resource <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Resource<span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// 성질 급한 초기화
</span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SafeLazyInitialization</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Resource resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Resource<span style=color:#f92672>();</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>synchronized</span> <span style=color:#66d9ef>static</span> Resource <span style=color:#a6e22e>getInstance</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResourceFactory</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ResourceHolder</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Resource resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Resource<span style=color:#f92672>();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Resource <span style=color:#a6e22e>getResource</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> ResourceHolder<span style=color:#f92672>.</span><span style=color:#a6e22e>resource</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=1624-double-checked-lock>
16.2.4 Double Checked Lock
<a class=anchor href=#1624-double-checked-lock>#</a>
</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DoubleCheckedLocking</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Resource resource<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Resource <span style=color:#a6e22e>getInstance</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>resource <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>synchronized</span><span style=color:#f92672>(</span>DoubleCheckedLocking<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>resource <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    resource <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Resource<span style=color:#f92672>();</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> resource<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ul>
<li>가독성 떨어짐&mldr;</li>
<li>부분 구성된 Resource 객체를 가져올 가능성 있음</li>
<li>volatile 쓸 것</li>
</ul>
<h2 id=163-초기화-안전성>
16.3 초기화 안전성
<a class=anchor href=#163-%ec%b4%88%ea%b8%b0%ed%99%94-%ec%95%88%ec%a0%84%ec%84%b1>#</a>
</h2>
<p><code>초기화 안전성(initialization safety)</code> : 올바르게 생성된 불변객체를 어떤 방법으로건 공개해도 별다른 동기화 구문 없이 안전하게 쓸 수 있다.</p>
<ul>
<li>final 로 선언된 변수를 갖고 있는 클래스는 초기화 안전성 조건 때문에 인스턴스 참조 최초 생성 때 재배치가 일어나지 않는다</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SafeStates</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> status<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>SafeStates</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        states <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;();</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getAbbreviation</span><span style=color:#f92672>(</span>String s<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> states<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>s<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>이 클래스는 스레드 안전하지만..</p>
<ul>
<li>states 가 final이 아니거나</li>
<li>생성자가 아닌 곳에서 states를 변경하거나</li>
<li>SafeStates class에 final로 선언되지 않은 다른 변수가 더 있다면 해당 변수들은
다른 쓰레드에서는 올바르게 못 볼 수 있다.</li>
<li>생성자 완료되기 전에 객체를 외부에 노출하는 경우에도..</li>
</ul>
<h2 id=요약>
요약
<a class=anchor href=#%ec%9a%94%ec%95%bd>#</a>
</h2>
<p>JMM은 어렵다.</p>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#161-자바-메모리-모델은-무엇이며-왜-사용해야-할까>16.1 자바 메모리 모델은 무엇이며, 왜 사용해야 할까?</a>
<ul>
<li><a href=#1611-플랫폼-메모리-모델>16.1.1 플랫폼 메모리 모델</a></li>
<li><a href=#1612-재배치>16.1.2 재배치</a></li>
<li><a href=#1613-자바-메모리-모델을-간략히-설명한다면>16.1.3 자바 메모리 모델을 간략히 설명한다면</a></li>
<li><a href=#1614-동기화-피기백>16.1.4 동기화 피기백</a></li>
</ul>
</li>
<li><a href=#162-안전한-공개>16.2 안전한 공개</a></li>
<li><a href=#1621-안전하지-못한-공개>16.2.1 안전하지 못한 공개</a></li>
<li><a href=#1622-안전한-공개>16.2.2 안전한 공개</a>
<ul>
<li><a href=#1623-안전한-초기화를-위한-구문>16.2.3 안전한 초기화를 위한 구문</a></li>
<li><a href=#1624-double-checked-lock>16.2.4 Double Checked Lock</a></li>
</ul>
</li>
<li><a href=#163-초기화-안전성>16.3 초기화 안전성</a></li>
<li><a href=#요약>요약</a></li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>